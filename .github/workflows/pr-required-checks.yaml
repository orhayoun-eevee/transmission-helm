name: PR Required Checks

on:
  pull_request:
    branches:
      - main

permissions:
  contents: read
  packages: read

concurrency:
  group: required-checks-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      run_validate: ${{ steps.filter.outputs.run_validate }}
      run_renovate_validation: ${{ steps.filter.outputs.run_renovate_validation }}
      run_scaffold_drift: ${{ steps.filter.outputs.run_scaffold_drift }}
      run_codeql: ${{ steps.filter.outputs.run_codeql }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Detect changed paths
        id: filter
        shell: bash
        run: |
          set -euo pipefail

          changed_files="$(git diff --name-only "${{ github.event.pull_request.base.sha }}" "${{ github.event.pull_request.head.sha }}")"
          run_validate=false
          run_renovate_validation=false
          run_scaffold_drift=false
          run_codeql=false

          if grep -Eq '^(Chart\.yaml|Chart\.lock|values\.yaml|templates/|tests/|charts/|scripts/|Makefile|ct\.yaml|\.checkov\.yaml|\.kube-linter\.yaml)' <<<"${changed_files}"; then
            run_validate=true
          fi

          if grep -Eq '^(renovate\.json|renovate\.json5|\.github/renovate\.json|\.github/renovate\.json5|\.github/workflows/renovate-config\.yaml)' <<<"${changed_files}"; then
            run_renovate_validation=true
          fi

          if grep -Eq '^(Makefile|scripts/bump-version\.sh|\.github/workflows/on-pr\.yaml|\.github/workflows/on-tag\.yaml|\.github/workflows/dependency-review\.yaml|\.github/workflows/codeql\.yaml|\.github/workflows/pr-required-checks\.yaml|\.github/workflows/renovate-config\.yaml|\.github/workflows/renovate-snapshot-update\.yaml|\.github/workflows/scaffold-drift-check\.yaml)' <<<"${changed_files}"; then
            run_scaffold_drift=true
          fi

          if grep -Eq '^(\.github/workflows/|scripts/|templates/|values\.yaml)' <<<"${changed_files}"; then
            run_codeql=true
          fi

          {
            echo "run_validate=${run_validate}"
            echo "run_renovate_validation=${run_renovate_validation}"
            echo "run_scaffold_drift=${run_scaffold_drift}"
            echo "run_codeql=${run_codeql}"
          } >> "${GITHUB_OUTPUT}"

  dependency-review:
    uses: orhayoun-eevee/build-workflow/.github/workflows/dependency-review.yaml@v0.1.4

  validate:
    needs: detect-changes
    if: needs.detect-changes.outputs.run_validate == 'true'
    permissions:
      contents: read
      packages: read
      issues: write
      pull-requests: write
    uses: orhayoun-eevee/build-workflow/.github/workflows/helm-validate.yaml@v0.1.4
    with:
      chart_path: .
      kubernetes_version: "1.30.0"
      scenarios_dir: tests/scenarios
      snapshots_dir: tests/snapshots
      run_syntax: true
      run_schema: true
      run_metadata: true
      run_tests: true
      run_policy: true
      target_branch: main
      run_version_check: true
    secrets:
      gh_app_id: ${{ secrets.GHCR_AUTO_APP_ID }}
      gh_app_private_key: ${{ secrets.GHCR_AUTO_PKEY }}

  renovate-config-validation:
    needs: detect-changes
    if: needs.detect-changes.outputs.run_renovate_validation == 'true'
    uses: orhayoun-eevee/build-workflow/.github/workflows/renovate-config.yaml@v0.1.4

  scaffold-drift-check:
    needs: detect-changes
    if: needs.detect-changes.outputs.run_scaffold_drift == 'true'
    uses: orhayoun-eevee/build-workflow/.github/workflows/scaffold-drift-check.yaml@v0.1.4
    with:
      repo_name: transmission-helm
    secrets:
      gh_app_id: ${{ secrets.GHCR_AUTO_APP_ID }}
      gh_app_private_key: ${{ secrets.GHCR_AUTO_PKEY }}

  codeql:
    needs: detect-changes
    if: needs.detect-changes.outputs.run_codeql == 'true'
    uses: orhayoun-eevee/build-workflow/.github/workflows/codeql.yaml@v0.1.4

  required-checks:
    name: required-checks
    if: always()
    runs-on: ubuntu-latest
    needs:
      - detect-changes
      - dependency-review
      - validate
      - renovate-config-validation
      - scaffold-drift-check
      - codeql
    steps:
      - name: Validate required job results
        shell: bash
        run: |
          set -euo pipefail

          declare -A job_results=(
            ["dependency-review"]="${{ needs.dependency-review.result }}"
            ["validate"]="${{ needs.validate.result }}"
            ["renovate-config-validation"]="${{ needs.renovate-config-validation.result }}"
            ["scaffold-drift-check"]="${{ needs.scaffold-drift-check.result }}"
            ["codeql"]="${{ needs.codeql.result }}"
          )

          failed=0
          for job in "${!job_results[@]}"; do
            result="${job_results[$job]}"
            echo "${job}: ${result}"
            if [[ "${result}" == "failure" || "${result}" == "cancelled" ]]; then
              failed=1
            fi
          done

          if [[ "${failed}" -ne 0 ]]; then
            echo "One or more required PR checks failed."
            exit 1
          fi

          echo "All required PR checks passed."
