# Default values for transmission
# Converted to libchart pattern (nested under app-chart dependency)
# ----------------------------------------------------------------------------
# Global Configuration
# ----------------------------------------------------------------------------
global:
  name: transmission
  namespace: download-clients
  chart:
    appVersion: 4.0.6
  labels: {}

# ----------------------------------------------------------------------------
# Service Configuration
# ----------------------------------------------------------------------------
network:
  enabled: true
  services:
    enabled: true
    items:
      http:
        enabled: true
        type: ClusterIP
        ports:
          http:
            port: 8080
            targetPort: http
            protocol: TCP
        annotations:
          description: "Transmission HTTP service"
      metrics:
        enabled: true
        type: ClusterIP
        ports:
          metrics:
            port: 9100
            targetPort: metrics
            protocol: TCP
        annotations:
          description: "Transmission metrics service"

  # ----------------------------------------------------------------------------
  # Feature: Networking (Gateway API & Security)
  # ----------------------------------------------------------------------------
  httpRoute:
    enabled: true
    port: 8080
    host: transmission-k8s.orhayoun.com
    gateway:
      name: shared-platform-gateway
      namespace: istio-system
    routes:
      # Main Application Route (HTTPS)
      - name: route
        enabled: true
        listener:
          sectionName: https
        rules:
          - matches:
              - path:
                  type: PathPrefix
                  value: /
            backendRefs:
              - name: transmission-http
                port: 8080
                weight: 100
                group: ""
                kind: Service

      # HTTP Redirect Route
      - name: http-redirect
        enabled: true
        listener:
          sectionName: http
        rules:
          - matches:
              - path:
                  type: PathPrefix
                  value: /
            filters:
              - type: RequestRedirect
                requestRedirect:
                  scheme: https
                  statusCode: 301

  networkPolicy:
    enabled: true
    items:
      default:
        enabled: true
        policyTypes:
          - Ingress
          - Egress
        ingress:
          - from:
              # Gateway traffic (HTTP + HBONE for ambient mesh)
              - namespaceSelector:
                  matchLabels:
                    kubernetes.io/metadata.name: istio-system
                podSelector:
                  matchLabels:
                    app.kubernetes.io/name: shared-platform-gateway

              # Prometheus metrics scraping (metrics port + HBONE for ambient mesh)
              - namespaceSelector:
                  matchLabels:
                    kubernetes.io/metadata.name: monitoring
                podSelector:
                  matchLabels:
                    app.kubernetes.io/name: prometheus

              # Media Services (Radarr, Sonarr)
              - namespaceSelector:
                  matchLabels:
                    kubernetes.io/metadata.name: media-center
                podSelector:
                  matchLabels:
                    app.kubernetes.io/part-of: media-center

              # Home Assistant API access (HTTP + HBONE for ambient mesh)
              - namespaceSelector:
                  matchLabels:
                    kubernetes.io/metadata.name: homeassistant
                podSelector:
                  matchLabels:
                    app.kubernetes.io/name: home-assistant
            ports:
              - protocol: TCP
                port: 15008

        egress:
          # DNS access (required for service discovery and external lookups)
          - to:
              - namespaceSelector:
                  matchLabels:
                    kubernetes.io/metadata.name: kube-system
                podSelector:
                  matchLabels:
                    k8s-app: kube-dns
            ports:
              - protocol: UDP
                port: 53
              - protocol: TCP
                port: 53

          - to:
              - namespaceSelector:
                  matchLabels:
                    kubernetes.io/metadata.name: istio-system
              - namespaceSelector:
                  matchLabels:
                    kubernetes.io/metadata.name: download-clients
            ports:
              - protocol: TCP
                port: 15008

          # Broad internet access required for BitTorrent protocol functionality
          - to:
              - ipBlock:
                  cidr: "0.0.0.0/0"
                  except:
                    - "10.42.0.0/16"
                    - "10.43.0.0/16"
                    - "192.168.0.0/16"
            ports:
              - protocol: TCP
                port: 443
              - protocol: TCP
                port: 51413 # Default BitTorrent peer communication port
              - protocol: UDP
                port: 51413 # UDP also used for DHT/PEX

  istio:
    enabled: true
    authorizationPolicy:
      enabled: true
      items:
        # Ingress gateway access - allows traffic from the gateway to the service
        ingress:
          enabled: true
          action: ALLOW
          rules:
            - from:
                - source:
                    principals:
                      - "cluster.local/ns/istio-system/sa/shared-platform-gateway-istio"
              to:
                - operation:
                    ports: ["8080"]
        # Prometheus metrics scraping - allows Prometheus to scrape metrics
        prometheus:
          enabled: true
          action: ALLOW
          rules:
            - from:
                - source:
                    principals:
                      - "cluster.local/ns/monitoring/sa/prometheus-kube-prometheus-prometheus"
              to:
                - operation:
                    ports: ["9100"]
        # Media Services access (Radarr/Sonarr)
        media-services:
          enabled: true
          action: ALLOW
          rules:
            - from:
                - source:
                    principals:
                      - "cluster.local/ns/media-center/sa/radarr"
                      - "cluster.local/ns/media-center/sa/sonarr"
              to:
                - operation:
                    ports: ["8080"]
        # Home Assistant access
        homeassistant:
          enabled: true
          action: ALLOW
          rules:
            - from:
                - source:
                    principals:
                      - "cluster.local/ns/homeassistant/sa/homeassistant-home-assistant"
              to:
                - operation:
                    ports: ["8080"]
    # ----------------------------------------------------------------------------
    # Circuit Breaker Configuration
    # ----------------------------------------------------------------------------
    destinationRule:
      enabled: true
      host: transmission-http
      trafficPolicy:
        connectionPool:
          tcp:
            maxConnections: 100
          http:
            http1MaxPendingRequests: 10
            http2MaxRequests: 100
            maxRequestsPerConnection: 2
        outlierDetection:
          consecutive5xxErrors: 5
          interval: 30s
          baseEjectionTime: 30s
          maxEjectionPercent: 50

# ----------------------------------------------------------------------------
# Deployment Configuration
# ----------------------------------------------------------------------------
deployment:
  replicas: 1
  strategy:
    type: Recreate
  revisionHistoryLimit: 3
  terminationGracePeriodSeconds: 60
  dnsPolicy: ClusterFirst
  enableServiceLinks: false
  automountServiceAccountToken: false

  # Pod labels
  podLabels:
    app.kubernetes.io/part-of: download-clients
    logging.kubernetes.io/component: download-clients
    logging.kubernetes.io/service: transmission

  # Pod security context
  podSecurityContext:
    fsGroup: 1010
    fsGroupChangePolicy: OnRootMismatch
    runAsNonRoot: true
    supplementalGroups: []

  # Main container configuration
  containers:
    transmission:
      enabled: true
      image:
        repository: ghcr.io/runlix/transmission
        tag: "release-4.0.6-latest@sha256:dc5948e80732d5dbc2ce4a9ed19a07c822de6348926833798c52c63be81af747"
        pullPolicy: IfNotPresent

      env:
        - name: TZ
          value: "UTC"
        - name: TRANSMISSION_WEB_HOME
          value: "/usr/share/transmission/public_html"
        - name: USER
          value: "admin"
        - name: TRANSMISSION_RPC_ENABLED
          value: "true"
        - name: TRANSMISSION_RPC_BIND_ADDRESS
          value: "0.0.0.0"
        - name: TRANSMISSION_RPC_PORT
          value: "8080"
        - name: TRANSMISSION_RPC_WHITELIST_ENABLED
          value: "false"
        - name: TRANSMISSION_RPC_HOST_WHITELIST_ENABLED
          value: "false"
        - name: TRANSMISSION_DOWNLOAD_DIR
          value: "/downloads/complete"
        - name: TRANSMISSION_INCOMPLETE_DIR_ENABLED
          value: "true"
        - name: TRANSMISSION_INCOMPLETE_DIR
          value: "/downloads/incomplete"
        - name: TRANSMISSION_WATCH_DIR_ENABLED
          value: "true"
        - name: TRANSMISSION_WATCH_DIR
          value: "/watch"
        - name: TRANSMISSION_PEER_LIMIT_GLOBAL
          value: "200"
        - name: TRANSMISSION_PEER_LIMIT_PER_TORRENT
          value: "50"
        - name: TRANSMISSION_SPEED_LIMIT_UP_ENABLED
          value: "false"
        - name: TRANSMISSION_SPEED_LIMIT_DOWN_ENABLED
          value: "false"
        - name: TRANSMISSION_BLOCKLIST_ENABLED
          value: "false"
        - name: TRANSMISSION_DHT_ENABLED
          value: "true"
        - name: TRANSMISSION_PEX_ENABLED
          value: "true"
        - name: TRANSMISSION_LPD_ENABLED
          value: "false"

      envFrom:
        - secretRef:
            name: transmission-secrets

      ports:
        - containerPort: 8080
          name: http
          protocol: TCP

      volumeMounts:
        - name: config
          mountPath: /config
        - name: downloads
          mountPath: /downloads
        - name: media
          mountPath: /media
        - name: watch
          mountPath: /watch

      # Health Probes (TCP Socket for distroless image)
      livenessProbe:
        tcpSocket:
          port: http
        failureThreshold: 3
        initialDelaySeconds: 30
        periodSeconds: 30
        successThreshold: 1
        timeoutSeconds: 10

      readinessProbe:
        tcpSocket:
          port: http
        failureThreshold: 3
        initialDelaySeconds: 15
        periodSeconds: 10
        successThreshold: 1
        timeoutSeconds: 10

      startupProbe:
        tcpSocket:
          port: http
        failureThreshold: 30
        initialDelaySeconds: 10
        periodSeconds: 5
        successThreshold: 1
        timeoutSeconds: 10

      # Container Security Context
      securityContext:
        readOnlyRootFilesystem: true
        runAsNonRoot: true
        runAsUser: 1011
        runAsGroup: 1010
        allowPrivilegeEscalation: false
        privileged: false
        appArmorProfile:
          type: RuntimeDefault
        capabilities:
          drop:
            - ALL
        seccompProfile:
          type: RuntimeDefault

      # Resources
      resources:
        requests:
          cpu: 100m
          memory: 256Mi
          ephemeral-storage: 2Gi
        limits:
          cpu: 1000m
          memory: 1Gi
          ephemeral-storage: 2Gi

    # Metrics exporter container
    transmission-exporter:
      enabled: true
      image:
        repository: metalmatze/transmission-exporter
        tag: "0.3.0@sha256:90d6acb6d47d717015eda05b8233e65e2236cbd2d56ceaf08411bbb964412c41"
        pullPolicy: IfNotPresent

      env:
        - name: WEB_ADDR
          value: ":9100"
        - name: TRANSMISSION_ADDR
          value: "http://localhost:8080"
        - name: TRANSMISSION_USERNAME
          value: "admin"
        - name: TRANSMISSION_PASSWORD
          valueFrom:
            secretKeyRef:
              name: transmission-secrets
              key: PASS

      ports:
        - containerPort: 9100
          name: metrics
          protocol: TCP

      # Health Probes
      livenessProbe:
        httpGet:
          path: /metrics
          port: metrics
          scheme: HTTP
        initialDelaySeconds: 30
        periodSeconds: 30
        timeoutSeconds: 5
        failureThreshold: 3
        successThreshold: 1

      readinessProbe:
        httpGet:
          path: /metrics
          port: metrics
          scheme: HTTP
        initialDelaySeconds: 10
        periodSeconds: 10
        timeoutSeconds: 5
        failureThreshold: 3
        successThreshold: 1

      startupProbe:
        httpGet:
          path: /metrics
          port: metrics
          scheme: HTTP
        initialDelaySeconds: 45
        periodSeconds: 10
        timeoutSeconds: 10
        failureThreshold: 30
        successThreshold: 1

      # Container Security Context
      securityContext:
        allowPrivilegeEscalation: false
        readOnlyRootFilesystem: true
        runAsNonRoot: true
        runAsUser: 65534  # nobody user
        runAsGroup: 65534
        appArmorProfile:
          type: RuntimeDefault
        capabilities:
          drop:
            - ALL
        seccompProfile:
          type: RuntimeDefault

      # Resources
      resources:
        requests:
          cpu: 10m
          memory: 32Mi
          ephemeral-storage: 100Mi
        limits:
          cpu: 100m
          memory: 64Mi
          ephemeral-storage: 100Mi

# ----------------------------------------------------------------------------
# Feature: Persistence
# ----------------------------------------------------------------------------
persistence:
  enabled: true
  claims:
    config:
      size: 1Gi
      storageClass: longhorn
      accessMode: ReadWriteOnce
      retain: true
  volumes:
    - name: config
      persistentVolumeClaim:
        claimName: transmission-config
    - name: downloads
      nfs:
        server: snorlax.orhayoun.com
        path: /mnt/vol1/media-center/downloads
    - name: media
      nfs:
        server: snorlax.orhayoun.com
        path: /mnt/vol1/media-center/media
    - name: watch
      emptyDir:
        sizeLimit: 1Gi

# ----------------------------------------------------------------------------
# Feature: Observability
# ----------------------------------------------------------------------------
metrics:
  enabled: true
  # ServiceMonitor Configuration
  serviceMonitor:
    enabled: true
    port: 9100
    interval: 10s
    scrapeTimeout: 5s
    path: /metrics
    honorLabels: true
    selector:
      matchLabels:
        app.kubernetes.io/name: transmission
        app.kubernetes.io/instance: transmission

    namespaceSelector:
      matchNames:
        - download-clients

    relabelings:
      - action: replace
        sourceLabels:
          - __meta_kubernetes_namespace
        targetLabel: namespace
      - action: replace
        sourceLabels:
          - __meta_kubernetes_pod_name
        targetLabel: instance

    metricRelabelings:
      - action: replace
        replacement: transmission
        targetLabel: service
      - action: replace
        replacement: download-clients
        targetLabel: component
  # PrometheusRule Configuration
  prometheusRule:
    enabled: true
    rules:
      # Copied from original transmission values.yaml
      - alert: TransmissionServiceDown
        expr: up{job="transmission"} == 0
        for: 2m
        labels:
          severity: critical
          service: transmission
          component: download-clients
        annotations:
          summary: "Transmission service is down"
          description: "Transmission service has been down for more than 2 minutes."
          runbook_url: "https://github.com/orHayoun/eevee/blob/main/services/transmission/README.md#troubleshooting"

      - alert: TransmissionHighMemoryUsage
        expr: |
          (
            container_memory_working_set_bytes{
              pod=~"transmission-.*",
              container="transmission",
              namespace="download-clients"
            }
            /
            on(pod, container, namespace)
            kube_pod_container_resource_limits{
              resource="memory",
              pod=~"transmission-.*",
              container="transmission",
              namespace="download-clients"
            }
          ) * 100 > 85
        for: 5m
        labels:
          severity: warning
          service: transmission
          component: download-clients
        annotations:
          summary: "Transmission high memory usage"
          description: "Transmission pod {{ $labels.pod }} memory usage is above 85% for more than 5 minutes."
          runbook_url: "https://github.com/orHayoun/eevee/blob/main/services/transmission/README.md#troubleshooting"

      - alert: TransmissionHighCPUUsage
        expr: |
          (
            rate(container_cpu_usage_seconds_total{
              pod=~"transmission-.*",
              container="transmission",
              namespace="download-clients"
            }[5m])
            /
            on(pod, container, namespace)
            kube_pod_container_resource_limits{
              resource="cpu",
              pod=~"transmission-.*",
              container="transmission",
              namespace="download-clients"
            }
          ) * 100 > 80
        for: 5m
        labels:
          severity: warning
          service: transmission
          component: download-clients
        annotations:
          summary: "Transmission high CPU usage"
          description: "Transmission pod {{ $labels.pod }} CPU usage is above 80% for more than 5 minutes."
          runbook_url: "https://github.com/orHayoun/eevee/blob/main/services/transmission/README.md#troubleshooting"

      - alert: TransmissionNFSStorageIssue
        expr: |
          up{job="transmission"} == 1
          and on()
          (
            node_filesystem_avail_bytes{mountpoint=~"/mnt/vol1/media-center/downloads.*"}
            /
            node_filesystem_size_bytes{mountpoint=~"/mnt/vol1/media-center/downloads.*"}
          ) * 100 < 10
        for: 5m
        labels:
          severity: critical
          service: transmission
          component: download-clients
          volume_type: nfs
        annotations:
          summary: "NFS downloads storage critically low"
          description: "NFS downloads storage on snorlax.orhayoun.com has less than 10% free space available."
          runbook_url: "https://github.com/orHayoun/eevee/blob/main/services/transmission/README.md#troubleshooting"

      - alert: TransmissionHighDiskIO
        expr: |
          rate(container_fs_reads_bytes_total{
            pod=~"transmission-.*",
            namespace="download-clients"
          }[5m])
          +
          rate(container_fs_writes_bytes_total{
            pod=~"transmission-.*",
            namespace="download-clients"
          }[5m]) > 50000000  # 50MB/s
        for: 10m
        labels:
          severity: warning
          service: transmission
          component: download-clients
        annotations:
          summary: "Transmission high disk I/O"
          description: "Transmission pod {{ $labels.pod }} has sustained high disk I/O (>50MB/s) for more than 10 minutes."
          runbook_url: "https://github.com/orHayoun/eevee/blob/main/services/transmission/README.md#troubleshooting"

      - alert: TransmissionHighPeerConnections
        expr: transmission_global_peer_limit{service="transmission", component="download-clients"} > 150
        for: 5m
        labels:
          severity: warning
          service: transmission
          component: download-clients
        annotations:
          summary: "Transmission high peer connection count"
          description: "Transmission global peer connections ({{ $value }}) are above 150 (75% of 200 limit) for more than 5 minutes."
          runbook_url: "https://github.com/orHayoun/eevee/blob/main/services/transmission/README.md#troubleshooting"

      - alert: TransmissionDownloadQueueStalled
        expr: transmission_queue_down{service="transmission", component="download-clients"} > 10
        for: 10m
        labels:
          severity: warning
          service: transmission
          component: download-clients
        annotations:
          summary: "Transmission download queue stalled"
          description: "Transmission download queue has {{ $value }} stalled items for more than 10 minutes."
          runbook_url: "https://github.com/orHayoun/eevee/blob/main/services/transmission/README.md#troubleshooting"

      - alert: TransmissionHighActiveTorrentCount
        expr: transmission_session_stats_torrents_active{service="transmission", component="download-clients"} > 50
        for: 5m
        labels:
          severity: info
          service: transmission
          component: download-clients
        annotations:
          summary: "Transmission high active torrent count"
          description: "Transmission has {{ $value }} active torrents for more than 5 minutes."
          runbook_url: "https://github.com/orHayoun/eevee/blob/main/services/transmission/README.md#troubleshooting"

      - alert: TransmissionTorrentCompleted
        expr: |
          increase(
            transmission_torrents_seeding{service="transmission", component="download-clients"}[5m]
          ) > 0
        for: 0m
        labels:
          severity: info
          service: transmission
          component: download-clients
        annotations:
          summary: "Transmission torrent completed"
          description: "A torrent has completed downloading and started seeding ({{ $value }} torrents completed in the last 5 minutes)."
          runbook_url: "https://github.com/orHayoun/eevee/blob/main/services/transmission/README.md#troubleshooting"

  # Grafana Configuration
  grafana:
    enabled: true
    instanceSelector:
      matchLabels:
        app.kubernetes.io/instance: prometheus
        app.kubernetes.io/name: grafana
    dashboard:
      enabled: true
      items:
        transmission-dashboard:
          enabled: true
          name: "application"
          allowCrossNamespaceImport: true
          file: "app.json"
# ----------------------------------------------------------------------------
# Service Account
# ----------------------------------------------------------------------------
serviceAccount:
  create: true
  name: "transmission"
  automount: false
  annotations:
    description: "Transmission media center service account"
    app.kubernetes.io/managed-by: "argocd"

# ----------------------------------------------------------------------------
# Pod Disruption Budget
# ----------------------------------------------------------------------------
podDisruptionBudget:
  enabled: false
  minAvailable: 1
  unhealthyPodEvictionPolicy: AlwaysAllow
