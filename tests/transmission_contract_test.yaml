suite: transmission chart contract
templates:
  - templates/all.yaml
tests:
  - it: renders expected default resource set and ingress host
    asserts:
      - hasDocuments:
          count: 16
      - documentSelector:
          path: metadata.name
          value: transmission-route
        equal:
          path: spec.hostnames[0]
          value: transmission-k8s.orhayoun.com
      - documentSelector:
          path: kind
          value: GrafanaDashboard
        equal:
          path: spec.instanceSelector.matchLabels["app.kubernetes.io/instance"]
          value: prometheus
      - documentSelector:
          path: kind
          value: GrafanaDashboard
        equal:
          path: spec.instanceSelector.matchLabels["app.kubernetes.io/name"]
          value: grafana
      - documentSelector:
          path: kind
          value: ServiceMonitor
        exists:
          path: metadata.name
      - documentSelector:
          path: kind
          value: DestinationRule
        equal:
          path: spec.host
          value: transmission-http

  - it: wires transmission application container security and storage correctly
    asserts:
      - documentIndex: 1
        equal:
          path: spec.template.spec.containers[0].name
          value: transmission
      - documentIndex: 1
        equal:
          path: spec.template.spec.containers[0].securityContext.readOnlyRootFilesystem
          value: true
      - documentIndex: 1
        equal:
          path: spec.template.spec.containers[0].securityContext.runAsUser
          value: 1011
      - documentIndex: 1
        equal:
          path: spec.template.spec.containers[0].securityContext.runAsGroup
          value: 1010
      - documentIndex: 15
        equal:
          path: metadata.name
          value: transmission-config

  - it: keeps minimal scenario render compact and deterministic
    values:
      - scenarios/minimal.yaml
    asserts:
      - hasDocuments:
          count: 5

  - it: disables destination rule when explicitly turned off
    set:
      network:
        istio:
          destinationRule:
            enabled: false
    asserts:
      - hasDocuments:
          count: 15

  - it: applies grafana instance selector overrides from values
    set:
      metrics:
        grafana:
          instanceSelector:
            matchLabels:
              app.kubernetes.io/instance: observability
              app.kubernetes.io/name: grafana-primary
    asserts:
      - documentSelector:
          path: kind
          value: GrafanaDashboard
        equal:
          path: spec.instanceSelector.matchLabels["app.kubernetes.io/instance"]
          value: observability
      - documentSelector:
          path: kind
          value: GrafanaDashboard
        equal:
          path: spec.instanceSelector.matchLabels["app.kubernetes.io/name"]
          value: grafana-primary

  - it: disables serviceMonitor when explicitly turned off
    set:
      metrics:
        serviceMonitor:
          enabled: false
    asserts:
      - hasDocuments:
          count: 15

  - it: applies httproute host override
    set:
      network:
        httpRoute:
          host: transmission.example.internal
    asserts:
      - documentSelector:
          path: metadata.name
          value: transmission-route
        equal:
          path: spec.hostnames[0]
          value: transmission.example.internal

  - it: applies destination rule host override
    set:
      network:
        istio:
          destinationRule:
            host: transmission-custom-http
    asserts:
      - documentSelector:
          path: kind
          value: DestinationRule
        equal:
          path: spec.host
          value: transmission-custom-http

  - it: disables grafana dashboard resources when grafana is disabled
    set:
      metrics:
        grafana:
          enabled: false
    asserts:
      - hasDocuments:
          count: 15

  - it: applies explicit transmission image override for controlled rollouts
    set:
      deployment:
        containers:
          transmission:
            image:
              repository: registry.internal/transmission
              tag: ci-test
    asserts:
      - documentIndex: 1
        equal:
          path: spec.template.spec.containers[0].image
          value: registry.internal/transmission:ci-test
